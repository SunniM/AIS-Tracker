<!DOCTYPE html>
<html>

<head>
    <script>
        HTMLCanvasElement.prototype.getContext = function (origFn) {
            return function (type, attribs) {
                attribs = attribs || {};
                attribs.preserveDrawingBuffer = true;
                return origFn.call(this, type, attribs);
            };
        }(HTMLCanvasElement.prototype.getContext);
    </script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        function loadMap() {
            var mapOptions = {
                mapId: 'a9e21ced58ad4189',
                center: new google.maps.LatLng(17.609993, 83.221436),
                zoom: 5,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true
            };
            var map = new google.maps.Map(document.getElementById("sample"), mapOptions);

            // Add an event listener to retrieve the coordinates
            map.addListener('idle', function () {
                const center = map.getCenter();
                const latitude = center.lat();
                const longitude = center.lng();
                const zoom = map.getZoom();

                // Create the data object with the coordinates
                const data = {
                    latitude: latitude,
                    longitude: longitude,
                    zoom: zoom,
                };

                // Capture the map image using html2canvas
                html2canvas(document.getElementById("sample")).then(function (canvas) {
                    // Convert the canvas to a data URL (base64-encoded)
                    const imageData = canvas.toDataURL("image/jpeg");

                    // Save the map image locally using fetch API
                    fetch('http://localhost:8080/save-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: imageData,
                        }),
                    }).then(function (response) {
                        console.log("Map image saved successfully");
                    }).catch(function (error) {
                        console.error("Error saving map image:", error);
                    });
                });

                // Send the POST request with the map data (excluding the image)
                fetch('http://localhost:8080', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                }).then(function (response) {
                    console.log("Map data sent successfully");
                }).catch(function (error) {
                    console.error("Error sending map data:", error);
                });
            });
        }

    </script>

</head>

<body onload="loadMap()">
    <div id="sample" style="width: 1920px; height:1080px;"></div>
    <div> </div>
</body>

</html>